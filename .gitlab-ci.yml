stages:
  - test
  - deploy

variables:
  POETRY_CACHE_DIR: "$CI_PROJECT_DIR/.cache"
  DOCKER_IMAGE: registry.opengeosys.org/ogs/tools/ogstools/ci-python-3.9

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
      changes:
        - Dockerfile
      variables:
        DOCKER_IMAGE: $CI_REGISTRY_IMAGE/ci-python-3.9:$CI_COMMIT_REF_SLUG
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

image: $DOCKER_IMAGE

cache:
  paths:
    - .cache

.setup-headless: &setup-headless
  - make setup
  - make setup_headless
  - source .venv/bin/activate

build:
  script:
    - pip install build
    - pyproject-build

tests (arch):
  tags: [shell, envinf]
  needs: []
  script:
    - *setup-headless
    - make test

tests:
  script:
    - *setup-headless
    - make test

tests feflow:
  image: registry.opengeosys.org/ogs/tools/feflow-python-docker:8.0.1
  script:
    - python -m venv .venv --upgrade-deps
    - .venv/bin/pip install --extra-index-url https://gitlab.opengeosys.org/api/v4/projects/120/packages/pypi/simple -e .[dev,test,docs,feflow]
    - make setup_headless
    - source .venv/bin/activate
    - make coverage
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

tests win:
  tags: [windows]
  needs: []
  before_script:
    - python -m venv .venv
    - .venv\Scripts\Activate.ps1
    - pip install --extra-index-url https://gitlab.opengeosys.org/api/v4/projects/120/packages/pypi/simple -e ".[dev,test]"
  script:
    - tox -p
    # Bug: -e docs only works on Windows when called from docs/-dir.
    - cd docs
    - tox -e docs

.docs-script: &docs-script
  - *setup-headless
  - pip install .[dev,test,docs,feflow]
  - make docs
  - mv docs/_build/html public

docs preview:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  image: registry.opengeosys.org/ogs/tools/feflow-python-docker:8.0.1
  script:
    - *docs-script
  artifacts:
    paths:
      - public
  environment:
    name: docs preview $CI_MERGE_REQUEST_IID $CI_PROJECT_ROOT_NAMESPACE
    url: "https://$CI_PROJECT_ROOT_NAMESPACE.$CI_PAGES_DOMAIN/-/$SUBGROUP_SLUG$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public/index.html"

pages:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: registry.opengeosys.org/ogs/tools/feflow-python-docker:8.0.1
  script:
    - *docs-script
  artifacts:
    paths:
      - public
  environment: production

publish:
  rules:
    - if: $CI_COMMIT_TAG
  variables:
    TWINE_REPOSITORY: pypi
    PYTHON_KEYRING_BACKEND: keyring.backends.null.Keyring
  script:
    - *setup-headless
    - tox -e publish

docker image:
  stage: .pre
  tags:
    - envinf
    - shell
  rules:
    - changes:
        - Dockerfile
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE
